<app-navbar></app-navbar>

<div class="container-fluid mt-4" *ngIf="idCementerio">
    <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 shadow-sm rounded border-start border-4 border-dark">
        <div>
            <h2 class="mb-0 fw-bold">{{ cementerio?.nombre || 'Cargando...' }}</h2>
            <p class="text-muted mb-0"><i class="bi bi-geo-alt-fill me-1"></i>{{ cementerio?.direccion }}</p>
        </div>
        <div class="d-flex gap-2">
            <button *ngIf="auth.esAdmin() || auth.esEmpresa()" class="btn btn-outline-dark px-4" (click)="abrirModalServicios()">
                <i class="bi bi-gear-fill me-2"></i>Servicios
            </button>
            <button *ngIf="auth.esAdmin()" class="btn btn-dark px-4" (click)="abrirModal()">
                <i class="bi bi-plus-circle me-2"></i>Nueva Agrupación
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9">
            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body p-0 plano-container">
                    <div class="wrapper-plano">
                        <img [src]="urlImagenPlano" class="img-fluid main-plano" draggable="false"
                            (error)="manejarErrorImagen($event)" (load)="manejarCargaImagen($event)">

                        <svg class="capa-interactiva" [attr.viewBox]="'0 0 ' + anchoOriginal + ' ' + altoOriginal"
                            preserveAspectRatio="xMidYMid meet">

                            <g *ngFor="let agru of agrupaciones" class="sector-svg">
                                <circle *ngIf="agru.tipo_forma === 'circle'"
                                    [attr.cx]="splitCoords(agru.coordenadas_mapa, 0)"
                                    [attr.cy]="splitCoords(agru.coordenadas_mapa, 1)"
                                    [attr.r]="splitCoords(agru.coordenadas_mapa, 2)" 
                                    class="elemento-interactivo" (click)="verDetalleAgrupacion(agru)">
                                </circle>

                                <rect *ngIf="agru.tipo_forma === 'rect'"
                                    [attr.x]="splitCoords(agru.coordenadas_mapa, 0)"
                                    [attr.y]="splitCoords(agru.coordenadas_mapa, 1)"
                                    [attr.width]="splitCoords(agru.coordenadas_mapa, 2)"
                                    [attr.height]="splitCoords(agru.coordenadas_mapa, 3)" 
                                    class="elemento-interactivo" (click)="verDetalleAgrupacion(agru)">
                                </rect>

                                <polygon *ngIf="agru.tipo_forma === 'polygon'" 
                                    [attr.points]="agru.coordenadas_mapa"
                                    class="elemento-interactivo" 
                                    (click)="verDetalleAgrupacion(agru)">
                                </polygon>

                                <text [attr.x]="obtenerXTexto(agru)"
                                      [attr.y]="obtenerYTexto(agru)" 
                                      text-anchor="middle" 
                                      dominant-baseline="middle"
                                      class="texto-sector">
                                    {{ agru.nombre }}
                                </text>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold border-0 pt-3"><i class="bi bi-layers me-2"></i>SECTORES</div>
                <div class="card-body p-2 overflow-auto">
                    <div *ngFor="let agru of agrupaciones"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 border rounded shadow-sm p-2 bg-white cursor-pointer">
                        <div (click)="verDetalleAgrupacion(agru)" class="flex-grow-1">
                            <span class="fw-bold d-block text-dark">{{ agru.nombre }}</span>
                            <small class="text-muted text-uppercase">{{ agru.tipo_forma }}</small>
                        </div>
                        <div class="btn-group btn-group-sm" *ngIf="auth.esAdmin()">
                            <button class="btn btn-outline-primary border-0" (click)="prepararEdicion(agru)"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-outline-danger border-0" (click)="abrirModalEliminar(agru)"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-backdrop-custom" *ngIf="mostrarModalAgrupacion && auth.esAdmin()">
    <div class="modal-content-custom shadow-lg">
        <div class="modal-header-custom bg-dark text-white p-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold">{{ agruAEditar ? 'EDITAR SECTOR' : 'NUEVO SECTOR' }}</h5>
            <button class="btn-close-custom text-white border-0 bg-transparent fs-4" (click)="cerrarModal()">&times;</button>
        </div>
        <div class="p-4">
            <app-form-agrupacion [idCementerioInput]="idCementerio" [agrupacionAEditar]="agruAEditar"
                (agrupacionCreada)="onAgrupacionCreada()" (cancelar)="cerrarModal()">
            </app-form-agrupacion>
        </div>
    </div>
</div>

<app-modal-gestion-servicios *ngIf="mostrarModalServicios" [idCementerio]="idCementerio" (onCerrar)="mostrarModalServicios = false"></app-modal-gestion-servicios>
<app-modal-confirmacion *ngIf="mostrarModalEliminar" [titulo]="'Eliminar Sector'" [mensaje]="'¿Borrar ' + agruAEliminar?.nombre + '?'" (confirmado)="confirmarEliminacion()" (cancelado)="mostrarModalEliminar = false"></app-modal-confirmacion>
<app-modal-sepultura #modalSep *ngIf="agrupacionSeleccionada" [agrupacion]="agrupacionSeleccionada" (cerrar)="agrupacionSeleccionada = null" (onConcesion)="abrirFormularioConcesion($event)"></app-modal-sepultura>
<app-form-concesion *ngIf="sepulturaSeleccionada" [sepultura]="sepulturaSeleccionada" (onCerrar)="sepulturaSeleccionada = null" (onExito)="finalizarTramite()"></app-form-concesion>

<app-mensajes-modal></app-mensajes-modal>
<app-footer></app-footer>